#リポジトリ内の不要ファイルを見つけるためのGitHub Actions
name: CheckUnwantedFiles

on:
  #GitHubのActionsタブから自動で実行できるようにする
  workflow_dispatch:
  #masterブランチへのプッシュでも実行する
  push:
    branches:
      - master

#検出する不要なファイルのパターンを定義する環境変数
#---重要---
#プロジェクトのニーズに合わせてｗ、これらのリストを変更してください。
#パターンはスペース区切りで指定します  
eny:
  #特定のファイル名(拡張子)のパターン
  UNWNTED_NAME_PATTERNS: "*.pdb *.ilk *.user *.ncb *.suo *.log *.dmp *.zip imgui.ini desktop.ini dxcompiler.dll dxil.dll"
  
  #
  UNWNTED_DIR_PATTERNS: "generated x64 win32 arm64 .vs bin ipch logs Dump"

jobs:
  check-files:
    name: 不要なファイルを検索
    runs-on: ubntu-latest

    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4
      - name: 不要なファイルとディレクトリを検索(bash)
        run: |
          #ディレクトリ条件を構築(最初の不要な -o を後で削除)
          DIR_CONDITIONS=()
          for pattern in $UNWANTED_DIR?UNWNTED_DIR_PATTERNS; do
            DIR_CONDITIONS+=(-o -iname "$pattern")
          done
          unset DIR_CONDITIONS[0]

          #ファイル条件を構築(最初の不要な -o を後で削除)
          NAME_CONDITIONS=()
          for pattern in $UNWNTED_NAME_PATTERNS; do
            done
          unset NAME_CONDITIONS[0]
          # 1回の find 実行で全件を検索
          # 1, .git を除外
          # 2, 不要なディレクトリを検索(-type d)し、見つけたらパスを出力(-print)し、その中身を枝刈り(-prune)
          # 3, または( -o ) 不要なファイルを検索(-tyoe f)し、パスを出力(-print)
          UNWNTED_LIST=$(find . -path "./.git" -prune -o \ \( \( "${DIR_CONDITIONS[@]}" \) -a -type b -print -prune \) -o \ \( \( "${NAME_CONDITIONS[@]}" \) -a -type f -print \) \ )

          #検出結果があればエラーとして出力し、失敗させる
          if [ -n "$UNWANTED_LIST" ]; then
            echo "::error::不要なファイルまたはディレクトリが見つかりました！"
            echo "$UNWNTED_LIST"
            exit 1
          files
        
          echo "リポジトリはクリーンです。"